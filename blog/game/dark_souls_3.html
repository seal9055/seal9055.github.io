<head> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5X8D3297QB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5X8D3297QB');
</script>
</head>
<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>Hacking Dark Souls 3</h1>
            <h2>January 2022</h2>
        </div>
    </div>
</div>
<H3>Introduction</H3>
<div class="paragraph">
    <p>
        Anyone that has played souls-like games before knows that they can get quite challenging, so why not make our lives a little easier by writing some cheats for Dark Souls 3.<br><br>

        In this post, I am going to start by covering basic cheat engine usage to extract information from the game. Since just running the cheats through cheat engine is boring, I will continue by translating the cheat table into a dll and write a dll-injector that we can use to inject the hack into the game. <br><br>

        The code for both the dll injector and the actual dll is written in Rust.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/1.png" alt="">
</div>
<H3>Cheat Table</H3>
<div class="paragraph">
    <p>
        Let's start by setting up our cheat table. To do this we will use a tool called cheat engine. The tool will allow us to quickly scan the memory of a process and attempt to find values.<br><br>

        Since dying appears to be a common problem in Dark Souls, we might as well try to start by making that a little harder. Our first goal is to try and find where in memory the game stores our health once we start it up. Cheat engine will prove very useful for this task.<br><br>

        To ultimately find the address of where the health value is stored, we will start by scanning memory for the exact value of our current health using cheat engine. Health is commonly stored as a 4-byte integer in games, so we will look for a 4-byte segment in writeable memory with the value of our current health, in this case, 800. <br><br>

        In this case, cheat engine found 9576 values in memory with that value. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/2.png" alt="">
</div>
<div class="paragraph">
    <p>
        Chances are that one of these above values found by cheat engine is used to track our health. These are obviously way too many values to manually verify though, so instead, we will let an enemy hit us, thus reducing our health, and then run yet another scan on this set of 9576 values with our new health value. The new set of values will be much smaller since only memory regions that contained 800 on the previous scan, and 630 on the current scan will be kept in the list.
        <br><br>

        We can repeat this process a couple of times until only a small amount of values are left (preferable < 10) that we can now manually check. This ends up providing us with both the health value and the maximum health cap, thus allowing us to edit our health by changing this value.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/3.png" alt="">
</div>
<div class="paragraph">
    <p>
        Ok, so we now have the ability to edit our health value, and make ourselves basically unkillable (outside of falling off the world edges). There is still one major issue we need to tackle though. These values are stored in memory that is dynamically allocated while loading the game. This means that if we restart the game, all of these values that we previously found will suddenly be invalid. We could of course repeat the previous process and find the health value again, but doing so every time we restart the game will quickly become tedious.<br><br>

        Luckily for us, cheat engine has another useful feature to help us with that. We can right-click the previously retrieved pointer and select the option to run a pointer scan. This will generate a list of pointer chains that lead from the program base to our selected pointer.<br><br>

        A possible pointer-chain could look something like this: <i>*(*(Program_base+0x2000)+0x80)</i>
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/4.png" alt="">
</div>
<div class="paragraph">
    <p>
        In this case, the list contains a couple hundred pointers. We however only need 1 working pointer chain that persists over program restarts. The easiest way to do this is to double-click a couple of chains from the list to add them to our table and restart the game. At this point, hopefully, one of the previously saved pointers is still valid.<br><br>

        Since only dealing with health is a little boring, we can repeat the previous process to find some more values. A small trick to speed this up a little is to manually inspect the memory region around the found health pointer. Chances are that other values pertaining to player stats are stored alongside the health.<br><br>

        After a bit of work we can construct the table shown below.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/5.png" alt="">
</div>
<div class="paragraph">
    <p>
        At this point, we could stop there and be happy that we can beat the game without even breaking a sweat. Having to deal with the cheat table though is not very convenient, especially if we would like to make the cheat publicly available. This would require every user to have cheat engine installed to use the cheat.<br><br>

        Instead, we can write a dll, inject it into the process upon startup, and use our cheats via a simple-to-use gui. Also, let's be honest, writing the hacks is much more interesting than playing the game anyways. The first step to making this work is to write a dll injector so that we can inject our dll into a running process.
        <br><br>
    </p>
</div>
<H3>Dll-Injector</H3>
<div class="paragraph">
    <p>
        You can see the code to achieve this below. Since we require winapi to accomplish this, the lines to load in all required modules almost match the entire code base for the dll-injector. First we set up a helper function: <i>get_func_address</i>. This function allows us to retrieve the address of an exported function from a dll of our choosing. We use this to retrieve the address of <i>LoadLibraryA</i>. <br><br>

        Next, let's get to the main part of the injector. The inject_dll function is supposed to be called from our script. We provide it with the process we are trying to inject a dll into, and the path to the dll we are trying to inject. Next we use <i>OpenProcess</i> to open our target via the specified pid. Note that this allows us access to an existing process and does not start a new process. Next we use <i>VirtualAllocEx</i> to allocate enough virtual memory within the process for our dll, and manually write it into that newly allocated space using <i>WriteProcessMemory</i>. Finally, we use the <i>CreateRemoteThread</i> winapi function to spawn a thread within the target process and run our dll.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">mem</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ffi</span>::<span class="n">CString</span><span class="p">;</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">winapi</span>::<span class="n">shared</span>::<span class="n">minwindef</span>::<span class="p">{</span><span class="n">LPVOID</span><span class="p">,</span><span class="w"> </span><span class="n">DWORD</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">};</span><span class="w"></span>
<span class="k">use</span><span class="w"> </span><span class="n">winapi</span>::<span class="n">um</span>::<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">memoryapi</span>::<span class="p">{</span><span class="n">VirtualAllocEx</span><span class="p">,</span><span class="w"> </span><span class="n">WriteProcessMemory</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">processthreadsapi</span>::<span class="p">{</span><span class="n">OpenProcess</span><span class="p">,</span><span class="w"> </span><span class="n">CreateRemoteThread</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">libloaderapi</span>::<span class="p">{</span><span class="n">GetModuleHandleA</span><span class="p">,</span><span class="w"> </span><span class="n">GetProcAddress</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="n">winnt</span>::<span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">PROCESS_CREATE_THREAD</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">PROCESS_VM_OPERATION</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">PROCESS_VM_WRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">MEM_RESERVE</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">PAGE_READWRITE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="sd">/// Get process address of specified function {func} in specified module {mod}</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_func_addr</span><span class="p">(</span><span class="n">module</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">func</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CString</span>::<span class="n">new</span><span class="p">(</span><span class="n">module</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CString</span>::<span class="n">new</span><span class="p">(</span><span class="n">func</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">module_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="n">module</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="n">GetProcAddress</span><span class="p">(</span><span class="n">module_handle</span><span class="p">,</span><span class="w"> </span><span class="n">func</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">())</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Inject dll specified by {dll_path} into process with the pid of {pid}</span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">inject_dll</span><span class="p">(</span><span class="n">pid</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">dll_path</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">load_lib_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_func_addr</span><span class="p">(</span><span class="s">"Kernel32.dll"</span><span class="p">,</span><span class="w"> </span><span class="s">"LoadLibraryA"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dll_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CString</span>::<span class="n">new</span><span class="p">(</span><span class="n">dll_path</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dll_path_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dll_path</span><span class="p">.</span><span class="n">as_bytes_with_nul</span><span class="p">().</span><span class="n">len</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_CREATE_THREAD</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESS_VM_OPERATION</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROCESS_VM_WRITE</span><span class="p">,</span><span class="w"> </span><span class="n">FALSE</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">va_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VirtualAllocEx</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="n">null_mut</span><span class="p">(),</span><span class="w"> </span><span class="n">dll_path_len</span><span class="p">,</span><span class="w"> </span><span class="n">MEM_RESERVE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MEM_COMMIT</span><span class="p">,</span><span class="w"> </span><span class="n">PAGE_READWRITE</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">WriteProcessMemory</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="n">va_path</span><span class="p">,</span><span class="w"> </span><span class="n">dll_path</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">LPVOID</span><span class="p">,</span><span class="w"> </span><span class="n">dll_path_len</span><span class="p">,</span><span class="w"> </span><span class="n">null_mut</span><span class="p">());</span><span class="w"></span>

<span class="w">    </span><span class="k">type</span> <span class="nc">ThreadStartRoutine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"system"</span><span class="w"> </span><span class="k">fn</span><span class="p">(</span><span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">DWORD</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">start_routine</span>: <span class="nc">ThreadStartRoutine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">transmute</span><span class="p">(</span><span class="n">load_lib_addr</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">CreateRemoteThread</span><span class="p">(</span><span class="n">proc</span><span class="p">,</span><span class="w"> </span><span class="n">null_mut</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">start_routine</span><span class="p">),</span><span class="w"> </span><span class="n">va_path</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">null_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="nb">Some</span><span class="p">(())</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<H3>Internal Game Hack</H3>
<div class="paragraph">
    <p>
        Now that we have the dll-injector we can get back to working on the actual game. Our goal is to write dll that we can inject into the process, but before we do that we need to write out a short exe. This will act as a wrapper to call the dll-injector and set everything up for us.<br><br>

        This code is very simple. We use a dependency called sysinfo to interact with the running processes and retrieve the pid of the Dark Souls process. Next we call the <i>inject_dll</i> function we defined earlier to inject the dll.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">path</span>::<span class="n">Path</span><span class="p">;</span><span class="w"></span>

<span class="k">use</span><span class="w"> </span><span class="n">sysinfo</span>::<span class="p">{</span><span class="n">ProcessExt</span><span class="p">,</span><span class="w"> </span><span class="n">System</span><span class="p">,</span><span class="w"> </span><span class="n">SystemExt</span><span class="p">};</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">DEBUG</span>: <span class="kt">bool</span> <span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span><span class="w"></span>

<span class="sd">/// Retrieves target pid, and uses it to inject selected DLL into target process</span>
<span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dll_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">DEBUG</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"target</span><span class="se">\\</span><span class="s">debug</span><span class="se">\\</span><span class="s">ds3_cheat.dll"</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s">"target</span><span class="se">\\</span><span class="s">release</span><span class="se">\\</span><span class="s">ds3_cheat.dll"</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dll</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Path</span>::<span class="n">new</span><span class="p">(</span><span class="n">dll_path</span><span class="p">).</span><span class="n">canonicalize</span><span class="p">().</span><span class="n">unwrap</span><span class="p">().</span><span class="n">into_os_string</span><span class="p">().</span><span class="n">into_string</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span>::<span class="n">new_all</span><span class="p">().</span><span class="n">process_by_name</span><span class="p">(</span><span class="s">"DarkSoulsIII"</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">pid</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">"[+] PID: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dll_injector</span>::<span class="n">inject_dll</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dll</span><span class="p">).</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="fm">println!</span><span class="p">(</span><span class="s">"Error injecting dll {} into process with pid: {}"</span><span class="p">,</span><span class="w"> </span><span class="n">dll_path</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<div class="paragraph">
    <p>
        Let's start by setting up the basic skeleton required for a dll. DllMain is the function that is initially called once the dll is loaded in. It verifies that the reason why it was called was that a new dll was attached, and proceeds to spawn a new thread to run the dll_attach_wrapper in. This wrapper just calls the <i>entry_point</i> function, passing along the base of the dll. The <i>entry_point</i> function is where the majority of the action will happen.<br><br>

        I am not exactly sure why this wrapper is necessary, but without it I was not able to get the dll to compile.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="sd">/// Entry point that gets called once the dll is injected into Dark Souls</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">entry_point</span><span class="p">(</span><span class="n">base</span>: <span class="nc">winapi</span>::<span class="n">shared</span>::<span class="n">minwindef</span>::<span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Small wrapper for the entry point</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"system"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">dll_attach_wrapper</span><span class="p">(</span><span class="n">base</span>: <span class="nc">winapi</span>::<span class="n">shared</span>::<span class="n">minwindef</span>::<span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">entry_point</span><span class="p">(</span><span class="n">base</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// DllMain is the main function that gets called when the dll is first attached</span>
<span class="sd">/// It creates a new thread to run the hack in</span>
<span class="cp">#[no_mangle]</span><span class="w"></span>
<span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">"stdcall"</span><span class="w"> </span><span class="k">fn</span> <span class="nf">DllMain</span><span class="p">(</span><span class="n">hinst_dll</span>: <span class="nc">HINSTANCE</span><span class="p">,</span><span class="w"> </span><span class="n">fdw_reason</span>: <span class="nc">DWORD</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">_lpv_reserved</span>: <span class="nc">LPVOID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">fdw_reason</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winapi</span>::<span class="n">um</span>::<span class="n">winnt</span>::<span class="n">DLL_PROCESS_ATTACH</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">winapi</span>::<span class="n">um</span>::<span class="n">processthreadsapi</span>::<span class="n">CreateThread</span><span class="p">(</span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">dll_attach_wrapper</span><span class="p">),</span><span class="w"> </span><span class="n">hinst_dll</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<div class="paragraph">
    <p>
        Since we want to use a gui for this application, let's start with that. We could do this using winapi, but this is a tedious process, so I opted to instead use a crate that makes this a whole lot easier: <a href=https://crates.io/crates/fltk/>fltk/</a>. Using it we can easily create a new window and add buttons to it for our needs. In the below example we set up a window and add a `quit` button. Next, we register a callback closure that gets called when the button is pressed. This function takes care of closing the app, and cleaning up all remains of the dll. This is also where we use the passed in `base` parameter to deallocate the memory allocated for the dll.<br><br>

        We could also just quit the application using the `x` button, but not properly deallocating memory will lead to undefined behavior once our dll is gone and the game keeps running. Finally we start up the window using the <i>run</i> method. This spawns the window below.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="sd">/// Entry point that gets called once the dll is injected into Dark Souls</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">entry_point</span><span class="p">(</span><span class="n">base</span>: <span class="nc">winapi</span>::<span class="n">shared</span>::<span class="n">minwindef</span>::<span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Draw the gui window and create the buttons</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span>::<span class="n">App</span>::<span class="n">default</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">wind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Window</span>::<span class="n">new</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">400</span><span class="p">,</span><span class="w"> </span><span class="mi">500</span><span class="p">,</span><span class="w"> </span><span class="s">"Dark Souls 3 Hack"</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">quit_button</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Button</span>::<span class="n">new</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="s">"Quit"</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">wind</span><span class="p">.</span><span class="n">set_color</span><span class="p">(</span><span class="n">Color</span>::<span class="n">White</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">wind</span><span class="p">.</span><span class="n">end</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">wind</span><span class="p">.</span><span class="n">show</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Set up the instructions that get executed whenever a button/field is used</span>
<span class="w">    </span><span class="n">quit_button</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">app</span><span class="p">.</span><span class="n">quit</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">wind</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">FreeLibraryAndExitThread</span><span class="p">(</span><span class="n">base</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">HMODULE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="mi">0</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<div>
    <img src="../imgs/game/ds3/6.png" alt="">
</div>
<div class="paragraph">
    <p>
        Let's think about what we want to do. Previously we used cheat engine to directly write to locations in memory. We now want to replicate this in our program. Since we are in a dll within the binary, we can just read/write memory without issues. We can set up 2 small helper functions to both read and write from memory.<br><br>

        The next thing we did through cheat engine was to bypass dynamic memory allocation via pointer chains. We could just dereference multiple pointers + offsets, but that is a messy solution and won't scale very well. Instead, we can just define another small helper function. We pass in an array of vectors and dereference an address for each offset. This allows us to dynamically retrieve the address at the end of the pointer chain and thus operate on the value we are interested in.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="sd">/// Use the offsets to traverse multi-level pointers starting at {ptr}</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bypass_dma</span><span class="p">(</span><span class="n">ptr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">usize</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">addr</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">addr</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Write {val} to {ptr}, uses the {offsets} to traverse multi level pointers</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">write_mem</span><span class="p">(</span><span class="n">ptr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">val</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bypass_dma</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">val_vec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">4</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">val_vec</span><span class="p">.</span><span class="n">write_u32</span>::<span class="o">&lt;</span><span class="n">LittleEndian</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">val</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="sd">/// Read value from {ptr}, uses the {offsets} to traverse multi level pointers</span>
<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">read_mem</span><span class="p">(</span><span class="n">ptr</span>: <span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bypass_dma</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="n">offsets</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="p">(</span><span class="n">addr</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">mut</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<div class="paragraph">
    <p>
        Now that we have the helper functions set up, let's complete the hack. We start by using a combination of <i>GetModuleInformation</i> and <i>GetCurrentProcess</i> to get the base address of this process. We will need this address to bypass aslr in case it is enabled on the system.<br><br>

        Next, we'll start by adding 2 new buttons. The first one is a toggleable button that allows us to define a callback that gets called whenever we toggle the button On/Off. The next one is an input button that allows the user to pass in a value to the callback function. Additionally, we add 2 frames. These are basically just small text sections on the window.
        <br><br>

        Next, we'll add a callback function for each button. The input button takes in a number that the user provides and writes it to the location of the health value in memory using the pointer chain we previously found using cheat engine. We make sure to overwrite both the health value and the maximum health cap. The toggleable infinite health button instead just edits the frame to display the string "On" or "Off" to the user, sets a variable that indicates that infinite health is enabled, and toggles the actual button.<br><br>

        Finally, we add 2 idle buttons. In fltk, these are run whenever nothing else is being done, so basically multiple times a second. The first one is in charge of displaying the current health value to the console at all times by reading the memory at the health pointer. The second one checks if the infinite health variable is set and if so writes the value 9999 to the health location in memory, thus making it impossible to die by taking damage.
        <br><br>
    </p>
</div>
<div class="demo-highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="w"> </span>: <span class="kt">usize</span> <span class="o">=</span><span class="w"> </span><span class="mh">0x04768E78</span><span class="p">;</span><span class="w"></span>

<span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span> <span class="nf">entry_point</span><span class="p">(</span><span class="n">base</span>: <span class="nc">winapi</span>::<span class="n">shared</span>::<span class="n">minwindef</span>::<span class="n">LPVOID</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u32</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">HASINFHP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Rc</span>::<span class="n">new</span><span class="p">(</span><span class="n">AtomicBool</span>::<span class="n">new</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Get program base address</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">modname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CString</span>::<span class="n">new</span><span class="p">(</span><span class="s">"DarkSoulsIII.exe"</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">m_info</span>: <span class="nc">MODULEINFO</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MODULEINFO</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">EntryPoint</span>: <span class="nc">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">(),</span><span class="w"></span>
<span class="w">        </span><span class="n">SizeOfImage</span>: <span class="mi">0</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">lpBaseOfDll</span>: <span class="nc">std</span>::<span class="n">ptr</span>::<span class="n">null_mut</span><span class="p">(),</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mem</span>::<span class="n">size_of</span>::<span class="o">&lt;</span><span class="n">MODULEINFO</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">GetModuleInformation</span><span class="p">(</span><span class="n">GetCurrentProcess</span><span class="p">(),</span><span class="w"> </span><span class="n">GetModuleHandleA</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="n">modname</span><span class="p">.</span><span class="n">as_c_str</span><span class="p">().</span><span class="n">as_ptr</span><span class="p">()),</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">m_info</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">base_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m_info</span><span class="p">.</span><span class="n">lpBaseOfDll</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Define a toggleable button that lets us maintain 9999 health</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">inf_hp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ToggleButton</span>::<span class="n">new</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="s">"Off"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="s">"INFINITE HEALTH"</span><span class="p">).</span><span class="n">with_align</span><span class="p">(</span><span class="n">Align</span>::<span class="n">Right</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Define a button that takes an input and sets the health to that value</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">health</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="n">IntInput</span>::<span class="n">new</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">health_frame</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Frame</span>::<span class="n">new</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span><span class="w"> </span><span class="mi">180</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">,</span><span class="w"> </span><span class="s">""</span><span class="p">).</span><span class="n">with_align</span><span class="p">(</span><span class="n">Align</span>::<span class="n">Right</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">health</span><span class="p">.</span><span class="n">set_callback</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">value</span><span class="p">().</span><span class="n">parse</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="n">write_mem</span><span class="p">(</span><span class="n">base_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3A0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="n">write_mem</span><span class="p">(</span><span class="n">base_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3A0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">]);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="w"> </span>
<span class="w">    </span><span class="n">inf_hp</span><span class="p">.</span><span class="n">set_callback</span><span class="p">({</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">HASINFHP</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HASINFHP</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">is_toggled</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="n">HASINFHP</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="n">toggle</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">"On"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="n">HASINFHP</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="n">toggle</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span><span class="w"></span>
<span class="w">                </span><span class="n">e</span><span class="p">.</span><span class="n">set_label</span><span class="p">(</span><span class="s">"Off"</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Add functions that consistently get executed during event loop. This one is used</span>
<span class="w">    </span><span class="c1">// to read out the health value and provide users with realtime feedback about their health</span>
<span class="w">    </span><span class="n">app</span>::<span class="n">add_idle</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_mem</span><span class="p">(</span><span class="n">base_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3A0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">"Set HEALTH (Current: {})"</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">health_frame</span><span class="p">.</span><span class="n">set_label</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">});</span><span class="w"></span>

<span class="w">    </span><span class="n">app</span>::<span class="n">add_idle</span><span class="p">(</span><span class="k">move</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">HASINFHP</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">Ordering</span>::<span class="n">Relaxed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">write_mem</span><span class="p">(</span><span class="n">base_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="p">,</span><span class="w"> </span><span class="mi">9999</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3A0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x98</span><span class="p">]);</span><span class="w"></span>
<span class="w">            </span><span class="n">write_mem</span><span class="p">(</span><span class="n">base_addr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">HEALTHOFFSET</span><span class="p">,</span><span class="w"> </span><span class="mi">9999</span><span class="p">,</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mh">0x40</span><span class="p">,</span><span class="w"> </span><span class="mh">0x28</span><span class="p">,</span><span class="w"> </span><span class="mh">0x3A0</span><span class="p">,</span><span class="w"> </span><span class="mh">0x70</span><span class="p">,</span><span class="w"> </span><span class="mh">0x90</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
<style id="css-style">pre { line-height: 125%; }
td.linenos .normal { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
span.linenos { color: #586e75; background-color: #073642; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.demo-highlight .hll { background-color: #073642 }
.demo-highlight { background: #002b36; color: #839496 }
.demo-highlight .c { color: #586e75; font-style: italic } /* Comment */
.demo-highlight .err { color: #839496; background-color: #dc322f } /* Error */
.demo-highlight .esc { color: #839496 } /* Escape */
.demo-highlight .g { color: #839496 } /* Generic */
.demo-highlight .k { color: #859900 } /* Keyword */
.demo-highlight .l { color: #839496 } /* Literal */
.demo-highlight .n { color: #839496 } /* Name */
.demo-highlight .o { color: #586e75 } /* Operator */
.demo-highlight .x { color: #839496 } /* Other */
.demo-highlight .p { color: #839496 } /* Punctuation */
.demo-highlight .ch { color: #586e75; font-style: italic } /* Comment.Hashbang */
.demo-highlight .cm { color: #586e75; font-style: italic } /* Comment.Multiline */
.demo-highlight .cp { color: #d33682 } /* Comment.Preproc */
.demo-highlight .cpf { color: #586e75 } /* Comment.PreprocFile */
.demo-highlight .c1 { color: #586e75; font-style: italic } /* Comment.Single */
.demo-highlight .cs { color: #586e75; font-style: italic } /* Comment.Special */
.demo-highlight .gd { color: #dc322f } /* Generic.Deleted */
.demo-highlight .ge { color: #839496; font-style: italic } /* Generic.Emph */
.demo-highlight .gr { color: #dc322f } /* Generic.Error */
.demo-highlight .gh { color: #839496; font-weight: bold } /* Generic.Heading */
.demo-highlight .gi { color: #859900 } /* Generic.Inserted */
.demo-highlight .go { color: #839496 } /* Generic.Output */
.demo-highlight .gp { color: #268bd2; font-weight: bold } /* Generic.Prompt */
.demo-highlight .gs { color: #839496; font-weight: bold } /* Generic.Strong */
.demo-highlight .gu { color: #839496; text-decoration: underline } /* Generic.Subheading */
.demo-highlight .gt { color: #268bd2 } /* Generic.Traceback */
.demo-highlight .kc { color: #2aa198 } /* Keyword.Constant */
.demo-highlight .kd { color: #2aa198 } /* Keyword.Declaration */
.demo-highlight .kn { color: #cb4b16 } /* Keyword.Namespace */
.demo-highlight .kp { color: #859900 } /* Keyword.Pseudo */
.demo-highlight .kr { color: #859900 } /* Keyword.Reserved */
.demo-highlight .kt { color: #b58900 } /* Keyword.Type */
.demo-highlight .ld { color: #839496 } /* Literal.Date */
.demo-highlight .m { color: #2aa198 } /* Literal.Number */
.demo-highlight .s { color: #2aa198 } /* Literal.String */
.demo-highlight .na { color: #839496 } /* Name.Attribute */
.demo-highlight .nb { color: #268bd2 } /* Name.Builtin */
.demo-highlight .nc { color: #268bd2 } /* Name.Class */
.demo-highlight .no { color: #268bd2 } /* Name.Constant */
.demo-highlight .nd { color: #268bd2 } /* Name.Decorator */
.demo-highlight .ni { color: #268bd2 } /* Name.Entity */
.demo-highlight .ne { color: #268bd2 } /* Name.Exception */
.demo-highlight .nf { color: #268bd2 } /* Name.Function */
.demo-highlight .nl { color: #268bd2 } /* Name.Label */
.demo-highlight .nn { color: #268bd2 } /* Name.Namespace */
.demo-highlight .nx { color: #839496 } /* Name.Other */
.demo-highlight .py { color: #839496 } /* Name.Property */
.demo-highlight .nt { color: #268bd2 } /* Name.Tag */
.demo-highlight .nv { color: #268bd2 } /* Name.Variable */
.demo-highlight .ow { color: #859900 } /* Operator.Word */
.demo-highlight .w { color: #839496 } /* Text.Whitespace */
.demo-highlight .mb { color: #2aa198 } /* Literal.Number.Bin */
.demo-highlight .mf { color: #2aa198 } /* Literal.Number.Float */
.demo-highlight .mh { color: #2aa198 } /* Literal.Number.Hex */
.demo-highlight .mi { color: #2aa198 } /* Literal.Number.Integer */
.demo-highlight .mo { color: #2aa198 } /* Literal.Number.Oct */
.demo-highlight .sa { color: #2aa198 } /* Literal.String.Affix */
.demo-highlight .sb { color: #2aa198 } /* Literal.String.Backtick */
.demo-highlight .sc { color: #2aa198 } /* Literal.String.Char */
.demo-highlight .dl { color: #2aa198 } /* Literal.String.Delimiter */
.demo-highlight .sd { color: #586e75 } /* Literal.String.Doc */
.demo-highlight .s2 { color: #2aa198 } /* Literal.String.Double */
.demo-highlight .se { color: #2aa198 } /* Literal.String.Escape */
.demo-highlight .sh { color: #2aa198 } /* Literal.String.Heredoc */
.demo-highlight .si { color: #2aa198 } /* Literal.String.Interpol */
.demo-highlight .sx { color: #2aa198 } /* Literal.String.Other */
.demo-highlight .sr { color: #cb4b16 } /* Literal.String.Regex */
.demo-highlight .s1 { color: #2aa198 } /* Literal.String.Single */
.demo-highlight .ss { color: #2aa198 } /* Literal.String.Symbol */
.demo-highlight .bp { color: #268bd2 } /* Name.Builtin.Pseudo */
.demo-highlight .fm { color: #268bd2 } /* Name.Function.Magic */
.demo-highlight .vc { color: #268bd2 } /* Name.Variable.Class */
.demo-highlight .vg { color: #268bd2 } /* Name.Variable.Global */
.demo-highlight .vi { color: #268bd2 } /* Name.Variable.Instance */
.demo-highlight .vm { color: #268bd2 } /* Name.Variable.Magic */
.demo-highlight .il { color: #2aa198 } /* Literal.Number.Integer.Long */</style>
<div class="paragraph">
    <p>
        We can repeat the above process for the remaining values in the cheat table and thus generate the below application.
        <br><br>

        With this, we successfully accomplished the previously set goals. We wrote a small dll injector that we used to inject a small dll into the game. This spawned a simple gui application allowing us to hack the game.<br><br>

        You can find the full code here: <a href=https://github.com/seal9055/darksouls3_cheats/>darksouls3_cheats/</a>.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/ds3/7.png" alt="">
</div>
<br><br><br><br><br>
<script>
    try {
        pageOpenedDirectly;
    } catch (e) {
        var loc = window.location.pathname;
        var dir = loc.substring(0, loc.lastIndexOf('/'));
        dir = dir.split("/")[dir.split("/").length - 1];
        let currentLoc = location.href;
        let currentFile = location.href.split("/").slice(-1);
        currentLoc = currentLoc.replace(currentFile, "");
        currentLoc = currentLoc.replace(dir+"/", "");
        currentLoc = currentLoc.slice(0, -1);
        if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);
        window.location = currentLoc + "?p=" + currentFile + "&d=" + dir;
    }
    </script>
