<head> 
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5X8D3297QB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5X8D3297QB');
</script>
</head>
<div class="page-header">
    <div class="page-header-inner">
        <div class="page-header-inner2">
            <h1>Hacking Minesweeper</h1>
            <h2>July 2021</h2>
        </div>
    </div>
</div>
<div class="paragraph">
    <p>
        I recently decided that I wanted to start learning a bit about game hacking to become a better reverse engineer, and figured, what better target than the classic minesweeper game? This is the first game I ever reversed, so my process was definitely not the most efficient, but after about 5 hours I accomplished the 2 goals I set for myself when starting this:<br><br>
        1. Guaranteed Win - I accomplished this by patching the binary to call the terminating function with arguments that result in a win upon hitting a bomb
        <br>
        2. Print out all bombs at game start - This was a bit more difficult. I had to create a code cave, and redirect execution to it to call a function that prints out the bombs right at the beginning before continuing execution without hangups. 
        <br><br>
        In the following writeup I will try to explain how I approached this problem. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/1.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        The first goal actually did not require much reversing at all. After playing the game for a bit I noticed that there was a distinct exploding sound whenever I hit a bomb and thus lost the game. Since minesweeper only has a couple of sounds (< 5), I figured this would be a good place to start. I opened up binary ninja and checked the code references for the windows api function: PlaySoundW(). As it turns out my suspicion was confirmed. This function is only called by 3 different functions which I decided to name play_sound[a,b,c]. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/2.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        Here I decided to bring out a debugger. I set breakpoints on all 3 functions one after another and checked when they were hit. As it turns out the first 2 were triggered consistently by the timer while the third remained untouched until we lost the game, at which point it got called. At this point I worked my way backwards through 2 more sets of code references via a similar process as the one above until I eventually arrived at the following function.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/3.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        What caught my attention here was that there are 2 slightly different code paths. The first pushes 0x0 before calling a series of functions that lead to PlaySoundW() while the second path pushes 0x1 before doing the same. I decided to play around with this a little, and quickly noticed that by patching the 'push 0x0' to a 'push 0x1', I could get the game to register a win instead of exploding. <br> Making this small patch resulted in the success message and a spot on the leaderboards upon hitting a bomb.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/4.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        Now you may be thinking that this was super simple and didn't actually require any proper reversing. Well, you're right. That's where the second part comes in. I decided to reverse the application's entire execution going through almost every single function to properly map out what it does. I am only going to cover the relevant parts for this writeup though. <br><br> Lets get started with our second goal, printing out all bombs before the game starts. We will start by taking a look at the main function. This is where I spent most of my time reversing. Since minesweeper is a gui app, it ended up having a lot of functions to properly set everything up. Therefore main starts out by calling several different functions and api calls to both start the program window, and draw the necessary structures. While this was quite interesting to reverse, its not directly relevant to this problem, so I will just leave a small snippet of the main function below to showcase a general overview of the steps it took. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/5.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        Now we will get to the interesting part. Further down in main we can find this infinite loop. After starting the first game, this loop runs all the way until we press the x to exit out of the application. It even continues if we hit a bomb. Since this loop is called right before starting the game, I decided that it would probably be interesting to work around it and make sure to execute the function to print out the bombs beforehand. Additionally, since the exit branch on the right side is never called until we actually close the program, it will make for a perfect code cave that we overwrite with our own code. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/6.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
        At this point there is only one more thing we have to find. We will return back to our earlier approach from the first part. Since we already know which set of functions is executed upon hitting a bomb, we can work backwards from there to figure out which function exactly is responsible for printing out the bombs. By using some breakpoints and single stepping through the code I eventually found the function I labeled 'draw_bombs'. This function is called by another function that is a direct xref from the previous sound_c function which is how I found it. <br><br> We don't need the specifics of the function (it mainly just checks which fields contain bombs, and then prints everything out), however it is noteworthy how eax is pushed onto the stack right before the function is called. I set a breakpoint on this instruction and ran the game a couple of times until I eventually confirmed that eax would always equal 0xa.
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/7.png" alt="">
</div>
<div class="paragraph">
    <p>
        <br><br>
         Now we have everything needed to accomplish goal #2: the draw_bombs() function alongside its arguments, the location we want to call it from, and a location for our code cave. Moving back to main, I patched out the instructions immediately prior to the loop to a jmp to our code cave. At this location I then execute 'push 0xa; call draw_bombs' before replacing the instructions I previously patched out and returning to normal execution. Now that all is done, when we open minesweeper all bombs are immediately printed out to us, thus giving us the ability to easily ignore the dangerous fields. <br><br>
         I hope you enjoyed this writeup. If you have any questions or comments, feel free to dm me on discord and I'll be sure to respond. 
        <br><br>
    </p>
</div>
<div>
    <img src="../imgs/game/minesweeper/8.png" alt="">
</div>
<script>
    try {
        pageOpenedDirectly;
    } catch (e) {
        var loc = window.location.pathname;
        var dir = loc.substring(0, loc.lastIndexOf('/'));
        dir = dir.split("/")[dir.split("/").length - 1];
        let currentLoc = location.href;
        let currentFile = location.href.split("/").slice(-1);
        currentLoc = currentLoc.replace(currentFile, "");
        currentLoc = currentLoc.replace(dir+"/", "");
        currentLoc = currentLoc.slice(0, -1);
        if (currentFile[0].indexOf(".html") !== -1) currentFile = currentFile[0].slice(0, -5);
        window.location = currentLoc + "?p=" + currentFile + "&d=" + dir;
    }
    </script>
